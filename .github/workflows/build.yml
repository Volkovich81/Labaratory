name: Build & SonarCloud

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build-and-scan:
    runs-on: windows-latest
    env:
      SONAR_ORG: volkovich81
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1

      - name: Build laba1
        run: |
          cd laba1
          mkdir build
          cd build
          cmake ..
          msbuild laba1.sln /p:Configuration=Release

      - name: Build laba2.1
        run: |
          cd laba2.1
          mkdir build
          cd build
          cmake ..
          msbuild laba2.1.sln /p:Configuration=Release

      - name: Build laba3
        run: |
          cd laba3
          mkdir build
          cd build
          cmake ..
          msbuild laba3.sln /p:Configuration=Release

      - name: Build laba4
        run: |
          cd laba4
          mkdir build
          cd build
          cmake ..
          msbuild laba4.sln /p:Configuration=Release
          
      - name: Build laba5
        run: |
          cd laba5
          mkdir build
          cd build
          cmake ..
          msbuild laba5.sln /p:Configuration=Release

      - name: Build laba6
        run: |
          cd laba6
          mkdir build
          cd build
          cmake ..
          msbuild laba6.sln /p:Configuration=Release

      - name: Generate compile_commands.json for laba6
        run: |
          cd laba6/build
          cmake -DCMAKE_EXPORT_COMPILE_COMMANDS=ON ..

      # SonarCloud scan laba1 (закомментировано)
      # - name: SonarCloud scan laba1
      #   uses: SonarSource/sonarqube-scan-action@v6
      #   env:
      #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      #   with:
      #     args: >
      #       -Dsonar.projectKey=volkovich81_Labaratory1
      #       -Dsonar.organization=${{ env.SONAR_ORG }}
      #       -Dsonar.sources=laba1
      #       -Dsonar.coverage.exclusions=**
      #       -Dsonar.cfamily.skipCoverage=true
      #       -Dsonar.issue.ignore.multicriteria=e1
      #       -Dsonar.issue.ignore.multicriteria.e1.ruleKey=cxx:S5025
      #       -Dsonar.issue.ignore.multicriteria.e1.resourceKey=**/*

      # SonarCloud scan laba2.1 (закомментировано)
      # - name: SonarCloud scan laba2.1
      #   uses: SonarSource/sonarqube-scan-action@v6
      #   env:
      #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      #   with:
      #     args: >
      #       -Dsonar.projectKey=volkovich81_Labaratory2.1
      #       -Dsonar.organization=${{ env.SONAR_ORG }}
      #       -Dsonar.sources=laba2.1
      #       -Dsonar.coverage.exclusions=**
      #       -Dsonar.cfamily.skipCoverage=true
      #       -Dsonar.issue.ignore.multicriteria=e1
      #       -Dsonar.issue.ignore.multicriteria.e1.ruleKey=cxx:S5025
      #       -Dsonar.issue.ignore.multicriteria.e1.resourceKey=**/*

      # SonarCloud scan laba3 (закомментировано)
      # - name: SonarCloud scan laba3
      #   uses: SonarSource/sonarqube-scan-action@v6
      #   env:
      #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      #   with:
      #     args: >
      #       -Dsonar.projectKey=volkovich81_Labaratory3
      #       -Dsonar.organization=${{ env.SONAR_ORG }}
      #       -Dsonar.sources=laba3
      #       -Dsonar.coverage.exclusions=**
      #       -Dsonar.cfamily.skipCoverage=true
      #       -Dsonar.issue.ignore.multicriteria=e1
      #       -Dsonar.issue.ignore.multicriteria.e1.ruleKey=cxx:S5025
      #       -Dsonar.issue.ignore.multicriteria.e1.resourceKey=**/*

      # SonarCloud scan laba4 (закомментировано)
      # - name: SonarCloud scan laba4
      #   uses: SonarSource/sonarqube-scan-action@v6
      #   env:
      #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      #   with:
      #     args: >
      #       -Dsonar.projectKey=volkovich81_Labaratory4
      #       -Dsonar.organization=${{ env.SONAR_ORG }}
      #       -Dsonar.sources=laba4
      #       -Dsonar.coverage.exclusions=**
      #       -Dsonar.cfamily.skipCoverage=true
      #       -Dsonar.issue.ignore.multicriteria=e1
      #       -Dsonar.issue.ignore.multicriteria.e1.ruleKey=cxx:S5025
      #       -Dsonar.issue.ignore.multicriteria.e1.resourceKey=**/*

      # SonarCloud scan laba5 (закомментировано)
      # - name: SonarCloud scan laba5
      #   uses: SonarSource/sonarqube-scan-action@v6
      #   env:
      #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      #   with:
      #     args: >
      #       -Dsonar.projectKey=volkovich81_Labaratory5
      #       -Dsonar.organization=${{ env.SONAR_ORG }}
      #       -Dsonar.sources=laba5
      #       -Dsonar.coverage.exclusions=**
      #       -Dsonar.cfamily.skipCoverage=true
      #       -Dsonar.issue.ignore.multicriteria=e1
      #       -Dsonar.issue.ignore.multicriteria.e1.ruleKey=cxx:S5025
      #       -Dsonar.issue.ignore.multicriteria.e1.resourceKey=**/*

      - name: SonarCloud scan laba6
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=volkovich81_Labaratory6
            -Dsonar.organization=${{ env.SONAR_ORG }}
            -Dsonar.sources=laba6
            -Dsonar.coverage.exclusions=**
            -Dsonar.cfamily.skipCoverage=true
            -Dsonar.issue.ignore.multicriteria=e1
            -Dsonar.issue.ignore.multicriteria.e1.ruleKey=cxx:S5025
            -Dsonar.issue.ignore.multicriteria.e1.resourceKey=**/*
            -Dsonar.cfamily.compile-commands=laba6/build/compile_commands.json
